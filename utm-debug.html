<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTM Debug Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f0f0f0; }
        .debug-section { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        pre { background: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>UTM Tracking Debug Test</h1>
    
    <div class="debug-section">
        <h2>Current URL Parameters</h2>
        <div id="url-params"></div>
    </div>
    
    <div class="debug-section">
        <h2>UTM Tracker Status</h2>
        <div id="tracker-status"></div>
    </div>
    
    <div class="debug-section">
        <h2>Stored UTM Parameters</h2>
        <div id="stored-params"></div>
    </div>
    
    <div class="debug-section">
        <h2>Test Event Tracking</h2>
        <button onclick="testEventTracking()">Test Event Tracking</button>
        <button onclick="testTypeformUTM()">Test Typeform UTM</button>
        <div id="event-results"></div>
    </div>
    
    <div class="debug-section">
        <h2>Console Logs</h2>
        <div id="console-logs"></div>
    </div>

    <!-- UTM Tracking Script -->
    <script src="utm-tracking.js"></script>
    
    <script>
        // Capture console logs
        const originalLog = console.log;
        const originalError = console.error;
        const logs = [];
        
        console.log = function(...args) {
            logs.push({type: 'log', message: args.join(' '), timestamp: new Date().toISOString()});
            originalLog.apply(console, args);
            updateConsoleLogs();
        };
        
        console.error = function(...args) {
            logs.push({type: 'error', message: args.join(' '), timestamp: new Date().toISOString()});
            originalError.apply(console, args);
            updateConsoleLogs();
        };
        
        function updateConsoleLogs() {
            const logsDiv = document.getElementById('console-logs');
            logsDiv.innerHTML = logs.map(log => 
                `<div class="${log.type}">[${log.timestamp}] ${log.message}</div>`
            ).join('');
        }
        
        function displayURLParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const paramsDiv = document.getElementById('url-params');
            
            if (urlParams.toString()) {
                paramsDiv.innerHTML = '<pre>' + urlParams.toString() + '</pre>';
            } else {
                paramsDiv.innerHTML = '<div class="info">No URL parameters found</div>';
            }
        }
        
        function checkTrackerStatus() {
            const statusDiv = document.getElementById('tracker-status');
            
            if (window.utmTracker) {
                statusDiv.innerHTML = '<div class="success">✅ UTM Tracker initialized successfully</div>';
            } else {
                statusDiv.innerHTML = '<div class="error">❌ UTM Tracker not found</div>';
            }
            
            if (window.trackEvent) {
                statusDiv.innerHTML += '<div class="success">✅ trackEvent function available</div>';
            } else {
                statusDiv.innerHTML += '<div class="error">❌ trackEvent function not available</div>';
            }
        }
        
        function displayStoredParams() {
            const storedDiv = document.getElementById('stored-params');
            
            try {
                const stored = localStorage.getItem('utm_params');
                const session = sessionStorage.getItem('utm_session');
                
                if (stored) {
                    storedDiv.innerHTML = '<h3>LocalStorage:</h3><pre>' + JSON.stringify(JSON.parse(stored), null, 2) + '</pre>';
                } else {
                    storedDiv.innerHTML += '<div class="info">No UTM parameters in localStorage</div>';
                }
                
                if (session) {
                    storedDiv.innerHTML += '<h3>SessionStorage:</h3><pre>' + JSON.stringify(JSON.parse(session), null, 2) + '</pre>';
                } else {
                    storedDiv.innerHTML += '<div class="info">No UTM parameters in sessionStorage</div>';
                }
            } catch (e) {
                storedDiv.innerHTML = '<div class="error">Error reading stored parameters: ' + e.message + '</div>';
            }
        }
        
        function testEventTracking() {
            const resultsDiv = document.getElementById('event-results');
            
            if (window.trackEvent) {
                try {
                    window.trackEvent('test_event', {
                        test_data: 'This is a test event',
                        timestamp: new Date().toISOString()
                    });
                    resultsDiv.innerHTML = '<div class="success">✅ Test event sent successfully</div>';
                } catch (e) {
                    resultsDiv.innerHTML = '<div class="error">❌ Error sending test event: ' + e.message + '</div>';
                }
            } else {
                resultsDiv.innerHTML = '<div class="error">❌ trackEvent function not available</div>';
            }
        }
        
        function testTypeformUTM() {
            const resultsDiv = document.getElementById('event-results');
            
            if (window.utmTracker) {
                try {
                    const utmParams = window.utmTracker.getUTMAsURLString();
                    const baseUrl = 'https://form.typeform.com/to/bO95W9RG';
                    const testUrl = utmParams ? baseUrl + '?' + utmParams : baseUrl;
                    
                    resultsDiv.innerHTML = `
                        <div class="success">✅ Typeform UTM Test</div>
                        <div class="info"><strong>Base URL:</strong> ${baseUrl}</div>
                        <div class="info"><strong>UTM Parameters:</strong> ${utmParams || 'None'}</div>
                        <div class="info"><strong>Final URL:</strong> ${testUrl}</div>
                        <div class="info"><strong>Test:</strong> <a href="${testUrl}" target="_blank">Open Typeform with UTM</a></div>
                    `;
                } catch (e) {
                    resultsDiv.innerHTML = '<div class="error">❌ Error testing Typeform UTM: ' + e.message + '</div>';
                }
            } else {
                resultsDiv.innerHTML = '<div class="error">❌ UTM Tracker not available</div>';
            }
        }
        
        // Initialize debug display
        document.addEventListener('DOMContentLoaded', function() {
            displayURLParams();
            
            // Wait a bit for UTM tracker to initialize
            setTimeout(() => {
                checkTrackerStatus();
                displayStoredParams();
            }, 1000);
        });
        
        // Update display every 2 seconds
        setInterval(() => {
            checkTrackerStatus();
            displayStoredParams();
        }, 2000);
    </script>
</body>
</html>
